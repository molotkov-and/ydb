# Очистка данных с диска

{% include [feature_certified.md](../_includes/feature_certified.md) %}

{{ ydb-short-name }} при обработке запросов на изменение или удаление данных может оставлять копии этих данных на диске, но помеченных как «удалённые». То есть получить эти данные путём пользовательских запросов к {{ ydb-short-name }} уже невозможно. Однако эти данные могут быть прочитаны за рамками {{ ydb-short-name }}, например, штатными функциями ОС по чтению диска или другими приложениями, получившими доступ к диску. Для минимизации риска прочтения ранее удалённой из базы данных информации {{ ydb-short-name }} предоставляет опциональную возможность запустить специализированную процедуру многократной перезаписи «удалённых» данных специальными битовыми последовательностями. Процедура представляет собой фоновый процесс и для его включения необходимо заполнить секцию конфигурации [data_erasure_config](../reference/configuration/shred_config.md). Процесс очистки является периодическим и после выполнения очистки запускается новый этап.

## Инструменты контроля процесса очистки

Процесс очистки данных может занимать продолжительное время. Текущий прогресс и состояние текущей итерации очистки данных можно получить путём анализа логов и опроса некоторых метрик.

### Логи

Процесс очистки поставляет логи на разных уровнях детализации.

Как сказано в [статье](../reference/configuration/shred_config.md), описывающей настройку процесса очистки, существует несколько уровней, на которых происходит очистка удалённых данных:

* Уровень кластера — очистка запускается для всех существующих баз данных;
* Уровень базы данных — очистка запускается для всех внутренних структур (таблеток) одной базы данных.

Каждый из этих уровней можно отличить друг от друга по префиксам:

* Логи с префиксом `[DomainShredManager]` относятся к уровню кластера. По ним можно узнать, в каких базах была запущена очистка, какие базы закончили процесс очистки и запустился ли процесс очистки в слое хранения.
* Логи с префиксом `[TenantShredManager]` относятся к уровню базы. По ним можно узнать, для каких таблеток запустился процесс очистки, а для каких уже закончился.

Подробное описание процесса настройки логирования описано в статье о [логировании](../devops/observability/logging.md) в {{ ydb-short-name }}. Для получения логов процесса очистки требуется настроить уровень логирования для компонента `FLAT_TX_SCHEMESHARD`.

#### Логирование уровня кластера

В результате успешного выполнения одной итерации очистки данных будет сгенерирован следующий набор сообщений уровня кластера:

{% note info %}

Сообщения на уровне кластера посылает таблетка корневого [SchemeShard](../concepts/glossary.md#scheme-shard), поэтому увидеть эти логи можно только на том узле, на котором запущена эта таблетка. При рестартах узла таблетка может оказаться на другом узле.

{% endnote %}

  1. `[DomainShredManager] Created: InflightLimit# 15, ShredInterval# 604800,`
  `ShredBSCInterval# 600, CurrentWakeupInterval# 604800, IsManualStartup# false`
  выводится при старте узла {{ ydb-short-name }}, на котором запущена таблетка корневого SchemeShard. Строка лога показывает, с какими текущими настройками будет запускаться очистка на уровне кластера. Уровень логирования `NOTICE`.
  1. `[DomainShredManager] Start: Generation# 15, Status# COMPLETED` — сигнализирует о запуске процесса очистки с текущим статусом. Уровень логирования `NOTICE`.
  1. `[DomainShredManager] ScheduleShredWakeup: Next shred iteration will run at  01-01-2025` — выводится в момент планирования следующей итерации очистки. Следующий запуск процесса очистки будет выполнен через в `01-01-2025`. Уровень логирования `NOTICE`.
  1. `[DomainShredManager] WakeupToRunShred: Timestamp# 01-01-2025` — выводится в момент, когда пришло время выполнить очередную итерацию очистки. Уровень логирования `DEBUG`.
  1. `TTxRunShred Execute at schemeshard: 22222222` — выводится при выполнении транзакции запуска очередной итерации очистки. `schemeshard: 22222222` — идентификатор таблетки корневого SchemeShard. Уровень логирования `DEBUG`.
  1. `[DomainShredManager] [Enqueue] Enqueued pathId# 12345 at schemeshard 22222222` — выводится при добавлении базы данных в очередь очистки. База данных характеризуется идентификатором пути `pathId# 12345`. `pathId` — идентификатор узла объекта схемы внутри указанного SchemeShard. По `pathId` можно восстановить путь до базы, открыв вкладку *Describe* в [Embedded UI](../reference/embedded-ui/ydb-monitoring.md). Уровень логирования `TRACE`.
  1. `[DomainShredManager] Run: Generation# 2, WaitingShredTenants.size# 2, Status# IN_PROGRESS` — запуск очередной итерации очистки для данных на уровне кластера с текущим статусом. Уровень логирования `NOTICE`.
      * `WaitingShredTenants.size` — количество баз, для которых очистка ещё не завершена.
  2. `TTxRunShred Complete at schemeshard: 22222222, NeedSendRequestToBSC# false` — выводится при завершении транзакции запуска очередной итерации очистки.
  3. `[DomainShredManager] [Start] Shred for pathId# 12345, tenant schemeshard# 5555555 at schemeshard 2222222`
  выводится при запуске очистки в конкретной базе данных. Уровень логирования `NOTICE`.
  1. `[DomainShredManager] [Finished] Shred completed for pathId# 12345 in# 900 ms at schemeshard 2222222`
  выводится при завершении очистки в конкретной базе данных. Можно увидеть время, за которое была выполнена очистка (`pathId# 12345 in# 900 ms`). Уровень логирования `INFO`.
  1. `[DomainShredManager] Shred in tenants is completed. Send request to BS controller` — означает завершение очистки внутренних структур во всех базах данных кластера. Старт запуска процедуры очистки в слое хранения. Уровень логирования `INFO`.
  2. `TTxCompleteShredBSC: Progress data shred in BSC 88.88%` — очистка в слое хранения завершена на 88%. Уровень логирования `NOTICE`.
  3. `[DomainShredManager] Complete: Generation# 5, duration# 6400 s` — завершение очередной (`Generation# 5`) итерации очистки данных, длящейся в общей сложности 6400 секунд. Уровень логирования `NOTICE`.
  4. `[DomainShredManager] Stop` — выводится в результате остановки процесса очистки. Уровень логирования `NOTICE`.

#### Логирование уровня базы данных

В результате успешного выполнения одной итерации очистки данных будет сгенерирован следующий набор сообщений уровня базы данных:

{% note info %}

Сообщения на уровне базы данных посылает таблетка SchemeShard конкретной базы данных, поэтому увидеть эти логи можно только на том узле, на котором запущена эта таблетка. При рестартах узла таблетка может оказаться на другом узле.

{% endnote %}

  1. `[TenantShredManager] Created: Rate# 2, InflightLimit# 15` — выводится при старте узла {{ ydb-short-name }}, на котором запущена таблетка SchemeShard, обслуживающая конкретную базу данных. Строка лога показывает, с какими текущими настройками будет запускаться очистка на уровне базы данных. Уровень логирования `NOTICE`.
  1. `[TenantShredManager] Start: Status# IN_PROGRESS, Generation# 5` — сигнализирует о запуске процесса очистки с текущим статусом. Уровень логирования `NOTICE`.
  1. `Handle TEvTenantShredRequest, at schemeshard: 55555555` — обработка запроса от таблетки корневого SchemeShard на выполнение очистки внутренних структур конкретной базы данных. Уровень логирования `DEBUG`.
  1. `TTxRunTenantShred: Execute at schemestard: 55555555` — выводится при выполнении транзакции запуска очередной итерации очистки внутренних структур конкретной базы данных. Уровень логирования `DEBUG`.
  1. `[TenantShredManager] [Enqueue] Enqueued shard# 987654321 at schemeshard 55555555` — выводится при добавлении таблетки в очередь очистки. Уровень логирования `TRACE`.
  1. `[TenantShredManager] StartShred: Generation# 5, WaitingShredShards.size# 50, Status# IN_PROGRESS` — запуск новой очистки для таблеток базы данных. Уровень логирования `NOTICE`.
      * `WaitingShredShards.size` — количество таблеток, для которых очистка ещё не завершена.
  1. `[TenantShredManager] [Start] Shred for pathId# 2, tabletId# 7777777, generation# 5 at schemeshard 55555555` - старт очистки в конкретной таблетке базы данных. Уровень логирования `INFO`.
  1. `[TenantShredManager] [Finished] Shred is completed for tabletId# 2, shardIdx# 12312313" in# 600 ms at schemeshard 12345` - выводится при завершении очистки в таблетке базы данных. Уровень логирования `INFO`.
  1. `[TenantShredManager] Shred in shards is completed: Generation# 5. Send response to domain schemeshard` — выводится при завершении очистки всех таблеток конкретной базы данных. Уровень логирования `NOTICE`.

### Метрики

В {{ ydb-short-name }} имеются [метрики](../reference/observability/metrics/index.md#shred), по которым также можно понять, на какой стадии находится процесс очистки.

Метрики позволяют контролировать прогресс выполнения очистки данных: в скольких базах данных завершена итерация очистки, для скольких баз очистка ещё выполняется, сколько таблеток в конкретной базе данных уже завершили очистку.

По метрикам можно прогнозировать время выполнения очистки и время, когда данные будут удалены.
