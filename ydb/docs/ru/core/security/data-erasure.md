# Очистка данных с диска

{{ ydb-short-name }} при обработке запросов на изменение или удаление данных может оставлять копии этих данных на диске, но помеченных как "удалённые". То есть получить эти данные путем пользовательских запросов к {{ ydb-short-name }} уже невозможно. Однако эти данные могут быть прочитаны за рамками {{ ydb-short-name }}, например, штатными функциями ОС по чтению диска, или другими приложениями, получивших доступ к диску. Для минимизации риска прочтения ранее удаленной из базы данных информации, {{ ydb-short-name }} предоставляет возможность запустить специализированную процедуру многократной перезаписи "удаленных" данных специальными битовыми последовательностями. Процедура представляет собой фоновый процесс, параметры запуска которого можно [настраивать](../reference/configuration/data_erasure_config.md).

## Инструменты контроля процесса очистки

Процесс очистки данных может занимать продолжительное время. Текущий прогресс и состояние текущей итерации очистки данных можно получить путем анализа логов и опроса некоторых метрик.

### Логи

Процесс очистки поставляет логи на разных уровнях детализации.

Как сказано в [статье](../reference/configuration/data_erasure_config.md), описывающей настройку процесса очистки, существует несколько уровней, на которых происходит очистка внутренних структур базы данных:

* Уровень кластера. Очистка запускается для всех существующих баз данных.
* Уровень базы данных. Очистка запускается для всех внутренних структур (таблеток) одной базы данных.

Каждый из этих уровней можно отличить друг от друга по префиксам:

* Логи с префиксом `[RootDataErasureManager]` относятся к уровню кластера. По ним можно узнать в каких базах была запущенна очистка, какие базы закончили процесс очистки, для каких баз сработал таймаут и запустился ли процесс очистки в слое хранения.
* Логи с префиксом `[TenantDataErasureManager]` относятся к уровню базы. По ним можно узнать для каких таблеток запустился процесс очистки, а для каких уже закончился, срабатывал ли таймаут при выполнении очистки.

Подробное описание процесса настройки логирования описано в статье о [логировании](../devops/observability/logging.md) в {{ ydb-short-name }}. Для получения логов процесса очистки требуется настроить уровень логирования для компонента `FLAT_TX_SCHEMESHARD`.

#### Логирование уровня кластера

В результате успешного выполнения одной итерации очистки данных будет сгенерирован следующий набор сообщений уровня кластера:

{% note info %}

Сообщения на уровне кластера посылает таблетка корневого [SchemeShard](../concepts/glossary.md#scheme-shard), поэтому увидеть эти логи можно только на том узле, на котором запущена эта таблетка. При рестартах узла таблетка может оказаться на другом узле.

{% endnote %}

  1. `[RootDataErasureManager] Created: Timeout# 15, Rate# 0, InflightLimit# 15, DataErasureInterval# 604800,`
  `DataErasureBSCInterval# 600, CurrentWakeupInterval# 604800, IsManualStartup# false`
  выводится при старте узла {{ ydb-short-name }}, на котором запущена таблетка корневого SchemeShard. Строка лога показывает с какими текущими настройками будет запускаться очистка на уровне кластера. Уровень логирования `NOTICE`.
  1. `[RootDataErasureManager] Start: Status# 0` - сигнализирует о запуске процесса очистки с текущим [статусом](#статус-операции). Уровень логирования `NOTICE`.
  1. `[RootDataErasureManager] ScheduleDataErasureWakeup: Interval# 604800, Timestamp# 01-01-2025` - выводится в момент планирования следующей итерации очистки. Следующий запуск процесса очистки будет выполнен через `Interval# 604800` секунд начиная с момента `Timestamp# 01-01-2025`. Уровень логирования `NOTICE`.
  1. `[RootDataErasureManager] WakeupToRunDataErasure: Timestamp# 01-01-2025` - выводится в момент, когда пришло время выполнить очередную итерацию очистки. Уровень логирования `DEBUG`.
  1. `TTxRunDataErasure Execute at schemeshard: 22222222` - выводится при выполнении транзакции запуска очередной итерации очистки. `schemeshard: 22222222` - идентификатор таблетки корневого SchemeShard. Уровень логирования `DEBUG`.
  1. `[RootDataErasureManager] Clear operation queue and active pipes` - сигнализирует об очистке очередей выполнения процесса очистки. Уровень логирования `TRACE`.
  1. `[RootDataErasureManager] Clear WaitingDataErasureTenants: Size# 5` - сигнализирует об очистке контейнера, содержащего информацию о базах данных, в которых ещё не завершена очистка. Уровень логирования `TRACE`.
  1. `[RootDataErasureManager] [Enqueue] Enqueued pathId# 12345 at schemeshard 22222222` - выводится при добавлении базы данных в очередь очистки. Базы данных характеризуется идентификатором пути `pathId# 12345`. `pathId` - идентификатор узла объекта схемы внутри указанного SchemeShard. По `pathId` можно восстановить путь до базы, открыв вкладку *Describe* в [Embedded UI](../reference/embedded-ui/ydb-monitoring.md). Уровень логирования `TRACE`.
  1. `[RootDataErasureManager] Run: Queue.Size# 2, WaitingDataErasureTenants.size# 2, Status# 1` - запуск очередной итерации очистки для данных на уровне кластера с текущим [статусом](#статус-операции). Уровень логирования `NOTICE`.
      * `Queue.Size` - количество баз, для которых была запущена очистка.
      * `WaitingDataErasureTenants.size` - количество баз, для которых очистка еще не завершена.
  1. `TTxRunDataErasure Complete at schemeshard: 22222222, NeedSendRequestToBSC# false` - выводится при завершении транзакции запуска очередной итерации очистки.
  1. `[RootDataErasureManager] [Start] Data erasure for pathId# 12345, tenant schemeshard# 5555555,`
  `next wakeup# 5, rate# 1, in queue# 2, running# 1 at schemeshard 2222222`
  выводится при запуске очистки в конкретной базе данных. Уровень логирования `NOTICE`.
  1. `[RootDataErasureManager] [Finished] Data erasure completed for pathId# 12345 in# 900 ms, next wakeup# 5,`
  `rate# 1, in queue# 0 tenants, running# 0 tenants at schemeshard 2222222`
  выводится при завершении очистки в конкретной базе данных. Можно увидеть время, за которое была выполнена очистка (`pathId# 12345 in# 900 ms`), количество баз данных ожидающих очистки (`in queue# 0 tenants`). Уровень логирования `INFO`.
  1. `[RootDataErasureManager] Data erasure in tenants is completed. Send request to BS controller` - означает завершение очистки внутренних структур во всех базах данных кластера. Старт запуска процедуры очистки в слое хранения. Уровень логирования `INFO`.
  1. `TTxCompleteDataErasureBSC: Progress data shred in BSC 88.88%` - очистка в слое хранения завершена на 88%. Уровень логирования `NOTICE`.
  1. `[RootDataErasureManager] Complete: Generation# 5, duration# 6400 s` - завершение очередной(`Generation# 5`) итерации очистки данных, длящейся в общей сложности 6400 секунд. Уровень логирования `NOTICE`.
  1. `[RootDataErasureManager] Stop` - выводится в результате остановки процесса очистки. Уровень логирования `NOTICE`.

#### Логирование уровня базы данных

В результате успешного выполнения одной итерации очистки данных будет сгенерирован следующий набор сообщений уровня базы данных:

{% note info %}

Сообщения на уровне базы данных посылает таблетка SchemeShard конкретной базы данных, поэтому увидеть эти логи можно только на том узле, на котором запущена эта таблетка. При рестартах узла таблетка может оказаться на другом узле.

{% endnote %}

  1. `[TenantDataErasureManager] Created: Timeout# 15, Rate# 2, InflightLimit# 15` - выводится при старте узла {{ ydb-short-name }}, на котором запущена таблетка SchemeShard, обслуживающая конкретную базу данных. Строка лога показывает с какими текущими настройками будет запускаться очистка на уровне базы данных. Уровень логирования `NOTICE`.
  1. `[TenantDataErasureManager] Start: Status# 1` - сигнализирует о запуске процесса очистки с текущим [статусом](#статус-операции). Уровень логирования `NOTICE`.
  1. `Handle TEvTenantDataErasureRequest, at schemeshard: 55555555` - обработка запроса от таблетки корневого SchemeShard на выполнение очистки внутренних структур конкретной базы данных. Уровень логирования `DEBUG`.
  1. `TTxRunTenantDataErasure Execute at schemestard: 55555555` - выводится при выполнении транзакции запуска очередной итерации очистки внутренних структур конкретной базы данных. Уровень логирования `DEBUG`.
  1. `[TenantDataErasureManager] Clear operation queue and active pipes` - сигнализирует об очистке очередей выполнения процесса очистки. Уровень логирования `TRACE`.
  1. `[TenantDataErasureManager] Clear WaitingDataErasureShards: Size# 50` - сигнализирует об очистке контейнера, содержащего информацию о таблетках, в которых ещё не завершена очистка. Уровень логирования `TRACE`.
  1. `[TenantDataErasureManager] [Enqueue] Enqueued shard# 987654321 at schemeshard 55555555` - выводится при добавлении таблетки в очередь очистки. Уровень логирования `TRACE`.
  1. `[TenantDataErasureManager] Run: Queue.Size# 50, WaitingDataErasureShards.size# 50, Status# 2` - запуск новой очистки для таблеток базы данных. Уровень логирования `NOTICE`.
      * `Queue.Size` - количество таблеток, для которых была запущена очистка.
      * `WaitingDataErasureShards.size` - количество таблеток, для которых очистка еще не завершена.
  1. `[TenantDataErasureManager] [Start] Data erasure for pathId# 2, datashard# 7777777, next wakeup# 5,`
  `rate# 15, in queue# 50 shards, running# 28 shards at schemeshard 12345`
  старт очистки в конкретной таблетке базы данных. Уровень логирования `INFO`.
  1. `[TenantDataErasureManager] [Finished] Data erasure is completed for pathId# 2, datashard# 777777777,`
  `shardIdx# 12312313" in# 600 ms, next wakeup in# 3600, rate# 50, in queue# 50 shards, running# 0 shards at schemeshard 12345`
  выводится при завершении очистки в таблетке базы данных. Уровень логирования `INFO`.
  1. `[TenantDataErasureManager] Data erasure in shards is completed. Send response to root schemeshard` - выводится при завершении очистки всех таблеток конкретной базы данных. Уровень логирования `NOTICE`.
  1. `[TenantDataErasureManager] Complete: Generation# 5` - завершение очистки таблеток в базе данных. Уровень логирования `NOTICE`.

#### Статус операции

В тексте логов очистки данных встречается информация о статусе операции, например `Status# 1`. Цифровые значения статусов нужно интерпретировать следующим образом:

0 - Статус не определен. Виден при первом запуске кластера.
1 - Операция завершена.
2 - Выполняется очистка внутренних структур (таблеток) базы данных.
3 - Выполняется очистка в слое хранения.

### Метрики

В {{ ydb-short-name }} имеются [метрики](../reference/observability/metrics/index.md#data_erasure), по которым также можно понять на какой стадии находится процесс очистки.

Метрики позволяют контролировать прогресс выполнения очистки данных: в скольких базах данных завершена итерация очистки, для скольких баз очистка еще выполняется, сколько таблеток в конкретной базе данных уже завершили очистку.

По метрикам можно прогнозировать время выполнения очистки и время, когда данные будут удалены.
