# Очистка данных с диска

{{ ydb-short-name }} при обработке запросов на изменение или удаление данных может оставлять копии этих данных на диске, но помеченных как "удалённые". То есть получить эти данные путем пользовательских запросов к {{ ydb-short-name }} уже невозможно. Однако эти данные могут быть прочитаны за рамками {{ ydb-short-name }}, например, штатными функциями ОС по чтению диска, или другими приложениями, получивших доступ к диску. Для минимизации риска прочтения ранее удаленной из базы данных информации, {{ ydb-short-name }} предоставляет возможность запустить специализированную процедуру многократной перезаписи "удаленных" данных специальными битовыми последовательностями. Процедура представляет собой повторяющийся фоновый процесс, для которого можно [настроить](../reference/configuration/data_erasure_config.md) период для планирования следующей очистки, а также ее интенсивность.

## Инструменты контроля процесса очистки

Процесс очистки данных может занимать продолжительное время. Текущий прогресс и состояние процесса очистки данных можно получить путем анализа логов и опроса некоторых метрик.

### Логи

Процесс очистки поставляет логи на разных уровнях подробности для контроля очистки.

Как сказано в [статье](../reference/configuration/data_erasure_config.md), описывающей настройку процесса очистки, существует несколько уровней, на которых происходит очистка внутренних структур базы данных:

 * Уровень кластера. Очистка запускается для всех существующих баз данных.
 * Уровень базы данных. Очистка запускается для всех внутренних структур (таблеток) одной базы данных.

Каждый из этих уровней можно отличить друг от друга по префиксам.
Логи с префиксом `[RootDataErasureManager]` относятся к уровню кластера. По ним можно узнать в каких базах была запущенна очистка, какие базы закончили процесс очистки, для каких баз сработал таймаут и запустился ли процесс очистки в слое хранения.
Логи с префиксом `[TenantDataErasureManager]` относятся к уровню базы. По ним можно узнать для каких таблеток запустился процесс очистки, а для каких уже закончился, срабатывал ли таймаут при выполнении очистки.

Примеры логов на уровне кластера:

  * `[RootDataErasureManager] Start: Status# 0` - выводится при переключении флага `enable_data_erasure` в значение `true`. Уровень логирования `NOTICE`.
  * `[RootDataErasureManager] Stop` - выводится при переключении флага `enable_data_erasure` в значение `false`. Уровень логирования `NOTICE`.
  * `[RootDataErasureManager] Run: Queue.Size# 2, WaitingDataErasureTenants.size# 2, Status# 1` - запуск новой очистки для баз кластера. Уровень логирования `NOTICE`.
    * `Queue.Size` - количество баз, для которых была запущена очистка.
    * `WaitingDataErasureTenants.size` - количество баз, для которых очистка еще не завершена.
  * `[RootDataErasureManager] ScheduleDataErasureWakeup: Interval# 600, Timestamp# 01-01-2025` - информация о том, через сколько секунд должна будет запуститься следующая очистка. Уровень логирования `NOTICE`.
  * `[RootDataErasureManager] [Start] Data erasure for pathId# 12345, tenant schemeshard# 5555555, next wakeup# 5, rate# 1, in queue# 2, running# 1 at schemeshard 2222222` - выводится при запуске очистки в конкретной базе данных. Уровень логирования `NOTICE`.
  * `[RootDataErasureManager] [Finished] Data erasure completed for pathId# 12345 in# 900 ms, next wakeup# 5, rate# 1, in queue# 0 tenants, running# 0 tenants at schemeshard 2222222` - выводится при завершении очистки в конкретной базе данных. Уровень логирования `INFO`.
  * `[RootDataErasureManager] Data erasure in tenants is completed. Send request to BS controller` - выводится при завершении очистки внутренних структур всех баз данных кластера. Старт очистки в слое хранения. Уровень логирования `INFO`.
  * `TTxCompleteDataErasureBSC: Progress data shred in BSC 88.88%` - очистка в слое хранения завершена на 88%. Уровень логирования `NOTICE`.
  * `[RootDataErasureManager] Complete: Generation# 5, duration# 6400 s` - завершение цикла очистки. После получения такого сообщения планируется новая очистка. Уровень логирования `NOTICE`.

На уровне базы данных логи очень похожи:

  * `[TenantDataErasureManager] Run: Queue.Size# 50, WaitingDataErasureShards.size# 50, Status# 1` - запуск новой очистки для таблеток базы данных. Уровень логирования `NOTICE`.
    * `Queue.Size` - количество таблеток, для которых была запущена очистка.
    * `WaitingDataErasureShards.size` - количество таблеток, для которых очистка еще не завершена.
  * `[TenantDataErasureManager] [Start] Data erasure for pathId# 2, datashard# 7777777, next wakeup# 5, rate# 15, in queue# 50 shards, running# 28 shards at schemeshard 12345` - старт очистки в конкретной таблетке базы данных. Уровень логирования `INFO`.
  * `[TenantDataErasureManager] [Finished] Data erasure is completed for pathId# 2, datashard# 777777777, shardIdx# 12312313" in# 600 ms, next wakeup in# 3600, rate# 50, in queue# 50 shards, running# 0 shards at schemeshard 12345` - выводится при завершении очистки в таблетке базы данных. Уровень логирования `INFO`.
  * `[TenantDataErasureManager] Data erasure in shards is completed. Send response to root schemeshard` - выводится при завершении очистки всех таблеток конкретной базы данных. Уровень логирования `NOTICE`.
  * `[TenantDataErasureManager] Complete: Generation# 5` - завершение очистки таблеток в базе данных. Уровень логирования `NOTICE`.

  По логам можно убедиться, что запись в базе данных действительно была удалена. Если операция удаления или модификации производилась до появления в логах сообщения вида `[RootDataErasureManager] Run: Queue.Size# 2, WaitingDataErasureTenants.size# 2, Status# 1`, то запись будет удалена с диска после появления в логах сообщения типа `[RootDataErasureManager] Complete: Generation# 5, duration# 6400 s`.

### Метрики

В {{ ydb-short-name }} имеются [метрики](../reference/observability/metrics/index.md#data_erasure), по которым также можно понять на какой стадии находится процесс очистки.

По метрикам можно понять прогресс выполнения очистки данных. Можно понять сколько бах данных уже выполнили очистку, для скольких баз очистка еще выполняется. Также можно узнать прогресс для конкретной базы данных, то есть по метрикам можно узнать количество таблеток завершивших очистку и ожидающих ее завершения.

По метрикам можно прогнозировать время выполнения очистки и время, когда данные будут удалены.
