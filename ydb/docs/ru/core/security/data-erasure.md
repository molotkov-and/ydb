# Очистка данных с диска

{{ ydb-short-name }} при обработке запросов на изменение или удаление данных может оставлять следы таких данных на диске, лишь помечая их как "удалённые". Таким образом "удалённые" данные могут оставаться на дисках и быть прочитаны штатными функциями ОС по чтению данных с диска.

Чтобы "удалённые" данные были физически очищены с диска, {{ ydb-short-name }} предоставляет возможность запустить специализированную процедуру, которая удалит все следы "удалённых" данных путем их многократной перезаписи. Процедура представляет собой повторяющийся фоновый процесс, для которого можно [настроить](../reference/configuration/index.md#data-erasure-config) период для планирования следующей очистки, а также ее интенсивность.

## Инструменты контроля процесса очистки

Для того чтобы следить за состоянием процесса очистки существуют различные инструменты - это записи в лог файлах и счетчики метрик.

### Логи

Процесса очистки поставляет логи на разных уровнях подробности для контроля очистки.

Как сказано в статье, описывающей настройку процесса очистки, существует несколько уровней, на которых происходит очистка данных:

 * Уровень кластера. Очистка запускается для всех существующих баз данных.
 * Уровень базы данных. Очистка запускается для всех внутренних структур одной базы данных.

Каждый из этих уровней можно отличить друг от друга по префиксам.
Логи с префиксом `[RootDataErasureManager]` относятся к уровню кластера. По ним можно узнать в каких базах была запущенна очистка, какие базы закончили процесс очистки и запустился ли процесс очистки в слое хранения.
Логи с префиксом `[TenantDataErasureManager]` относятся к уровню базы. По ним можно узнать для каких таблеток запустился процесс очистки, а для каких уже закончился и так далее.

Примеры логов на уровне кластера:
  * `[RootDataErasureManager] Start: Status# 0` - выводится при переключении флага `enable_data_erasure` в значение `true`. Уровень логирования `NOTICE`.
  * `[RootDataErasureManager] Run: Queue.Size# 2, WaitingDataErasureTenants.size# 2, Status# 1` - запуск новой очистки для баз кластера. Уровень логирования `TRACE`.
    * `Queue.Size` - количество баз, для которых была запущена очистка.
    * `WaitingDataErasureTenants.size` - количество баз, для которых очистка еще не завершена.
  * `[RootDataErasureManager] ScheduleDataErasureWakeup: Interval# 600, Timestamp# 01-01-2025` - информация о том, через сколько секунд должна будет запуститься следующая очистка. Уровень логирования `DEBUG`.
  * `[RootDataErasureManager] [Start] Data erasure for pathId# 12345, tenant schemeshard# 5555555, next wakeup# 5, rate# 1, in queue# 2, running# 1 at schemeshard 2222222` - выводится при запуске очистки в конкретной базе данных. Уровень логирования `INFO`.
  * `[RootDataErasureManager] [Finished] Data erasure completed for pathId# 12345 in# 900 ms, next wakeup# 5, rate# 1, in queue# 0 tenants, running# 0 tenants at schemeshard 2222222` - выводится при завершении очистки в конкретной базе данных. Уровень логирования `INFO`.
  * `[RootDataErasureManager] Data erasure in tenants is completed. Send request to BS controller` - выводится при завершении очистки внутренних структур всех баз данных кластера. Старт очистки в слое хранения. Уровень логирования `INFO`.
  * `TTxCompleteDataErasureBSC: Progress data shred in BSC 88.88%` - очистка в слое хранения завершена на 88%. Уровень логирования `INFO`.
  * `[RootDataErasureManager] Complete: Generation# 5, duration# 6400 s` - завершение цикла очистки. После получения такого сообщения планируется новая очистка. Уровень логирования `INFO`.

На уровне базы данных логи очень похожи:
  * `[TenantDataErasureManager] Run: Queue.Size# 50, WaitingDataErasureShards.size# 50, Status# 1` - запуск новой очистки для таблеток базы данных. Уровень логирования `TRACE`.
    * `Queue.Size` - количество таблеток, для которых была запущена очистка.
    * `WaitingDataErasureShards.size` - количество таблеток, для которых очистка еще не завершена.
  * `[TenantDataErasureManager] [Start] Data erasure for pathId# 2, datashard# 7777777, next wakeup# 5, rate# 15, in queue# 50 shards, running# 28 shards at schemeshard 12345` - старт очистки в конкретной таблетке базы данных. Уровень логирования `INFO`.
  * `[TenantDataErasureManager] [Finished] Data erasure is completed for pathId# 2, datashard# 777777777, shardIdx# 12312313" in# 600 ms, next wakeup in# 3600, rate# 50, in queue# 50 shards, running# 0 shards at schemeshard 12345` - выводится при завершении очистки в таблетке базы данных. Уровень логирования `INFO`.
  * `[TenantDataErasureManager] Data erasure in shards is completed. Send response to root schemeshard` - выводится при завершении очистки всех таблеток конкретной базы данных. Уровень логирования `INFO`.
  * `[TenantDataErasureManager] Complete: Generation# 5` - завершение очистки таблеток в базе данных.

  По логам можно убедиться, что запись в базе данных действительно была удалена. Если операция удаления или модификации производилась до появления в логах сообщения вида `[RootDataErasureManager] Run: Queue.Size# 2, WaitingDataErasureTenants.size# 2, Status# 1`, то запись будет удалена с диска после появления в логах сообщения типа `[RootDataErasureManager] Complete: Generation# 5, duration# 6400 s`.

### Метрики

В {{ ydb-short-name }} имеются метрики, по которым также можно понять на какой стадии находится процесс очистки.

  * `DataErasureQueueSize` - количество баз данных, для которых будет выполнена очистка.
  * `DataErasureQueueRunning` - количество баз данных, для которых очистка производится в данный момент.
  * `TenantDataErasureQueueSize` - количество таблеток в базе данных, для которых будет выполнена очистка.
  * `TenantDataErasureQueueRunning` - количество таблеток в базе данных, для которых очистка производится в данный момент.
  * `DataErasureOK` - количество баз данных, в которых завершена очистка внутренних структур.
  * `DataErasureTimeout` - количество баз данных. для которых истекло время ожидания очистки внутренних структур.
  * `TenantDataErasureOK` - количество таблеток, завершивших очистку.
  * `TenantDataErasureTimeout` - количество таблеток, которые не успели завершить очистку за отведенное время.
